    {% load static %}
    {% load custom_filters %}
    <!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Discussion - {{ session.patient.nom_complet }} | Lobiko</title>
        
        <!-- Styles -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        <link rel="stylesheet" href="{% static 'css/lobiko-styles.css' %}">
        <link rel="stylesheet" href="{% static 'css/discussion.css' %}">
        <link rel="stylesheet" href="{% static 'css/discussions.css' %}">
        <!-- Styles pour les prescriptions -->
        <style>
            
        </style>
        <script>
            // CORRECTION: R√©cup√©ration correcte des IDs depuis le contexte Django
            const sessionId = {{ session.id|default:0 }};
            
            // CORRECTION: R√©cup√©ration de l'ID du m√©decin selon la structure de votre mod√®le
            {% if user.is_authenticated and user.medecin %}
                const medecinId = {{ user.medecin.id }};
            {% elif medecin %}
                const medecinId = {{ medecin.id }};
            {% else %}
                const medecinId = 0;
            {% endif %}
            
            // Debug pour v√©rifier les valeurs
            console.log('üîç Debug - Session ID:', sessionId, 'Medecin ID:', medecinId);
            
            // CORRECTION: V√©rification que les IDs sont valides
            if (sessionId === 0 || medecinId === 0) {
                console.error('‚ùå ERREUR: IDs manquants - Session ID:', sessionId, 'Medecin ID:', medecinId);
            }
        </script>
    </head>
    <body>
        <!-- En-t√™te Lobiko -->
        <header class="lobiko-header">
            <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="lobiko-logo">
                        <img src="{% static 'images/lobiko.png' %}" alt="Logo Lobiko">
                    </div>
                    <div style="color: white;">
                        <h1 style="margin: 0; font-size: 1.8rem; font-weight: 600;">Lobiko</h1>
                        <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Plateforme de Sant√© Professionnelle</p>
                    </div>
                </div>
                <nav style="display: flex; gap: 1rem;">
                    <a href="{% url 'dashboard_medecin' %}" style="color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 20px; background: rgba(255,255,255,0.2); transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0)'">
                        <i class="fas fa-home"></i> Tableau de bord
                    </a>
                    <a href="{% url 'logout_medecin' %}" style="color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 20px; background: rgba(255,255,255,0.2); transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0)'">
                        <i class="fas fa-sign-out-alt"></i> D√©connexion
                    </a>
                </nav>
            </div>
        </header>

        <div class="discussion-container">
            <!-- En-t√™te de la discussion -->
            <div class="discussion-header">
                <div class="patient-info">
                    <div class="patient-avatar">
                        {{ session.patient.prenom|first }}{{ session.patient.nom|first }}
                    </div>
                    <div class="patient-details">
                        <h2>{{ session.patient.nom_complet }}</h2>
                        <div class="patient-meta">
                            <div class="meta-item">
                                <i class="fas fa-phone"></i>
                                <span>{{ session.patient.telephone }}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-birthday-cake"></i>
                                <span>{{ session.patient.age }} ans</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-venus-mars"></i>
                                <span>{{ session.patient.get_sexe_display }}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>{{ session.patient.commune }}, {{ session.patient.quartier }}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-language"></i>
                                <span>{{ session.patient.langues_display }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="discussion-actions">
                        {% if not session.date_fin %}
                            <span class="status-badge status-active">
                                <i class="fas fa-circle"></i> En cours
                            </span>
                        {% else %}
                            <span class="status-badge status-ended">
                                <i class="fas fa-check-circle"></i> Termin√©e
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Zone de chat -->
            <div class="chat-area">
                <div class="messages-container" id="messagesContainer">
                    {% for msg in all_messages %}
                        <div class="message-group">
                            <div class="message-bubble {% if msg.emetteur_type == 'MEDECIN' %}medecin{% elif msg.emetteur_type == 'PATIENT' %}patient{% else %}system{% endif %}">
                                <div class="message-content {% if msg.emetteur_type == 'MEDECIN' %}medecin{% elif msg.emetteur_type == 'PATIENT' %}patient{% else %}system{% endif %}">
                                    {% if msg|class_name == 'MediaMessage' %}
                                    <!-- Affichage des m√©dias -->
                                    <div class="media-message">
                                        {% if msg.media_type == 'image' %}
                                            <div class="media-container">
                                                <img src="{{ msg.file_url }}" alt="Image envoy√©e" loading="lazy">
                                                <div class="media-actions">
                                                    <a href="{{ msg.file_url }}" target="_blank" class="lobiko-btn lobiko-btn-sm lobiko-btn-outline">
                                                        <i class="fas fa-expand"></i> Agrandir
                                                    </a>
                                                    <a href="{% url 'proxy_download' session.id msg.id %}" class="lobiko-btn lobiko-btn-sm lobiko-btn-primary">
                                                        <i class="fas fa-download"></i> T√©l√©charger
                                                    </a>
                                                </div>
                                            </div>
                                        {% elif msg.media_type == 'audio' %}
                                            <div class="audio-container">
                                                <audio controls>
                                                    <source src="{{ msg.file_url }}" type="audio/mpeg">
                                                    Votre navigateur ne supporte pas l'audio.
                                                </audio>
                                                <div class="media-actions">
                                                    <a href="{% url 'proxy_download' session.id msg.id %}" class="lobiko-btn lobiko-btn-sm lobiko-btn-primary">
                                                        <i class="fas fa-download"></i> T√©l√©charger
                                                    </a>
                                                </div>
                                            </div>
                                        {% elif msg.media_type == 'video' %}
                                            <div class="video-container">
                                                <video controls width="300">
                                                    <source src="{{ msg.file_url }}" type="video/mp4">
                                                    Votre navigateur ne supporte pas la vid√©o.
                                                </video>
                                                <div class="media-actions">
                                                    <a href="{% url 'proxy_download' session.id msg.id %}" class="lobiko-btn lobiko-btn-sm lobiko-btn-primary">
                                                        <i class="fas fa-download"></i> T√©l√©charger
                                                    </a>
                                                </div>
                                            </div>
                                        {% elif msg.media_type == 'document' %}
                                            <div class="document-container">
                                                <div class="document-info">
                                                    <i class="fas fa-file-alt"></i>
                                                    <span>{{ msg.original_filename|default:"Document" }}</span>
                                                </div>
                                                <div class="media-actions">
                                                    <a href="{{ msg.file_url }}" target="_blank" class="lobiko-btn lobiko-btn-sm lobiko-btn-outline">
                                                        <i class="fas fa-eye"></i> Voir
                                                    </a>
                                                    <a href="{% url 'proxy_download' session.id msg.id %}" class="lobiko-btn lobiko-btn-sm lobiko-btn-primary">
                                                        <i class="fas fa-download"></i> T√©l√©charger
                                                    </a>
                                                </div>
                                            </div>
                                        {% endif %}

                                        {% if msg.caption %}
                                            <p class="media-caption">{{ msg.caption }}</p>
                                        {% endif %}
                                    </div>

                                {% elif "Lien pour la consultation vid√©o:" in msg.contenu %}
                                    <!-- Gestion sp√©cifique du lien Jitsi -->
                                    <div class="jitsi-message">
                                        <p>{{ msg.contenu|linebreaksbr }}</p>
                                        <div class="media-actions">
                                            <button onclick="joinJitsiCall('{{ msg.contenu|slice:'34:' }}')" 
                                                    class="lobiko-btn lobiko-btn-sm lobiko-btn-success">
                                                <i class="fas fa-video"></i> Rejoindre l'appel vid√©o
                                            </button>
                                        </div>
                                    </div>

                                {% else %}
                                    <!-- Message texte normal -->
                                    <p class="text-message">{{ msg.contenu|linebreaksbr }}</p>
                                {% endif %}

                                </div>
                                <div class="message-time">
                                    {{ msg.date_envoi|date:"H:i" }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Actions et formulaire de message -->
                {% if not session.date_fin %}
                    <div class="chat-input-area">
                        <!-- Boutons d'action pour les prescriptions -->
                        <div class="action-buttons" style="padding: 1rem; border-top: 1px solid #e9ecef; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <form method="POST" action="{% url 'initier_appel_jitsi' session.id %}">
                                {% csrf_token %}
                                <button type="submit" class="action-btn-prescription" id="appel">
                                    <i class="fas fa-video"></i> D√©marrer un appel vid√©o
                                </button>
                            </form>
                            <button class="action-btn-prescription" onclick="ouvrirModalPrescription()">
                                <i class="fas fa-pills"></i> Cr√©er une ordonnance
                            </button>
                            <button class="action-btn-examen" onclick="ouvrirModalBonExamen()">
                                <i class="fas fa-microscope"></i> Prescrire des examens
                            </button>
                            <div class="text-center">
                                <form method="POST" class="mb-3">
                                    {% csrf_token %}
                                    <button type="submit" name="close_session" class="action-btn-examen" id="termine">
                                        <i class="fas fa-times-circle"></i> Terminer la discussion
                                    </button>
                                </form>
                            </div>

                        </div>

                        <form id="messageForm" method="POST">
                            {% csrf_token %}
                            <div class="input-container">
                                <textarea 
                                    name="message" 
                                    class="message-input" 
                                    placeholder="Tapez votre message ici..."
                                    rows="1"
                                    required></textarea>
                                <button type="submit" class="send-button">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                {% else %}
                    <div class="session-ended">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #4CAF50; margin-bottom: 1rem;"></i>
                        <h3>Discussion termin√©e</h3>
                        <p>Cette consultation s'est termin√©e le {{ session.date_fin|date:"d/m/Y √† H:i" }}</p>
                        <a href="{% url 'dashboard_medecin' %}" class="lobiko-btn lobiko-btn-primary">
                            <i class="fas fa-home"></i> Retour au tableau de bord
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Modales pour les prescriptions -->
        <div id="prescriptionModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-pills"></i> Cr√©er une Ordonnance</h3>
                    <span class="close" onclick="fermerModalPrescription()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="prescriptionForm">
                        <!-- Informations g√©n√©rales -->
                        <div class="form-section">
                            <h4><i class="fas fa-info-circle"></i> Informations g√©n√©rales</h4>
                            <div class="form-group">
                                <label for="diagnostic">Diagnostic <span class="required">*</span></label>
                                <textarea id="diagnostic" name="diagnostic" rows="3" placeholder="Diagnostic principal..." required></textarea>
                                <div class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="motif_prescription">Motif de la prescription</label>
                                <textarea id="motif_prescription" name="motif_prescription" rows="2" placeholder="Motif de la prescription..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="instructions_generales">Instructions g√©n√©rales</label>
                                <textarea id="instructions_generales" name="instructions_generales" rows="3" placeholder="Instructions g√©n√©rales pour le patient..."></textarea>
                            </div>
                        </div>

                        <!-- M√©dicaments -->
                        <div class="form-section">
                            <h4><i class="fas fa-pills"></i> M√©dicaments prescrits</h4>
                            <div id="medicaments-container">
                                <!-- Les m√©dicaments seront ajout√©s dynamiquement ici -->
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="ajouterMedicament()">
                                <i class="fas fa-plus"></i> Ajouter un m√©dicament
                            </button>
                        </div>

                        <!-- Validit√© -->
                        <div class="form-section">
                            <h4><i class="fas fa-calendar"></i> Validit√©</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="date_validite">Date de validit√©</label>
                                    <input type="date" id="date_validite" name="date_validite">
                                </div>
                                <div class="form-group">
                                    <label for="renouvelable">
                                        <input type="checkbox" id="renouvelable" name="renouvelable">
                                        Renouvelable
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fermerModalPrescription()">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="envoyerPrescription()">
                        <i class="fas fa-paper-plane"></i> Envoyer l'ordonnance
                    </button>
                </div>
            </div>
        </div>

        <div id="bonExamenModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-microscope"></i> Cr√©er un Bon d'Examens</h3>
                    <span class="close" onclick="fermerModalBonExamen()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="bonExamenForm">
                        <!-- Informations g√©n√©rales -->
                        <div class="form-section">
                            <h4><i class="fas fa-info-circle"></i> Informations g√©n√©rales</h4>
                            <div class="form-group">
                                <label for="motif_examens">Motif des examens <span class="required">*</span></label>
                                <textarea id="motif_examens" name="motif_examens" rows="3" placeholder="Motif des examens demand√©s..." required></textarea>
                                <div class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="diagnostic_provisoire">Diagnostic provisoire</label>
                                <textarea id="diagnostic_provisoire" name="diagnostic_provisoire" rows="2" placeholder="Diagnostic provisoire..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="renseignements_cliniques">Renseignements cliniques</label>
                                <textarea id="renseignements_cliniques" name="renseignements_cliniques" rows="3" placeholder="Renseignements cliniques pertinents..."></textarea>
                            </div>
                        </div>

                        <!-- Priorit√© et d√©lais -->
                        <div class="form-section">
                            <h4><i class="fas fa-exclamation-triangle"></i> Priorit√© et d√©lais</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="priorite">Priorit√©</label>
                                    <select id="priorite" name="priorite">
                                        <option value="NORMAL">Normal</option>
                                        <option value="URGENT">Urgent</option>
                                        <option value="TRES_URGENT">Tr√®s urgent</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="delai_realisation">D√©lai de r√©alisation</label>
                                    <input type="text" id="delai_realisation" name="delai_realisation" placeholder="Ex: Dans les 48h">
                                </div>
                                <div class="form-group">
                                    <label for="validite_jours">Validit√© (jours)</label>
                                    <input type="number" id="validite_jours" name="validite_jours" value="60" min="1" max="365">
                                </div>
                            </div>
                        </div>

                        <!-- Examens -->
                        <div class="form-section">
                            <h4><i class="fas fa-microscope"></i> Examens prescrits</h4>
                            <div id="examens-container">
                                <!-- Les examens seront ajout√©s dynamiquement ici -->
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="ajouterExamen()">
                                <i class="fas fa-plus"></i> Ajouter un examen
                            </button>
                        </div>

                        <!-- Instructions de pr√©paration -->
                        <div class="form-section">
                            <h4><i class="fas fa-clipboard-list"></i> Instructions de pr√©paration</h4>
                            <div class="form-group">
                                <label for="instructions_preparation">Instructions sp√©ciales</label>
                                <textarea id="instructions_preparation" name="instructions_preparation" rows="4" placeholder="Instructions sp√©ciales de pr√©paration pour le patient..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fermerModalBonExamen()">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="envoyerBonExamen()">
                        <i class="fas fa-paper-plane"></i> Envoyer le bon d'examens
                    </button>
                </div>
            </div>
        </div>

        <script>
            let discussionSocket = null;
            let medicamentCounter = 0;
            let examenCounter = 0;
            let produitsPharmaceutiques = [];
            let actesMedicaux = [];
            
            // Auto-scroll vers le bas du chat
            function scrollToBottom() {
                const container = document.getElementById('messagesContainer');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }
            
            // Auto-resize du textarea
            function autoResize(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }
            
            // Fonction de validation des champs requis
            function validerChampRequis(element, nomChamp) {
                const valeur = element.value.trim();
                const errorElement = element.parentNode.querySelector('.error-message');
                
                if (!valeur) {
                    element.classList.add('error');
                    if (errorElement) {
                        errorElement.textContent = `${nomChamp} est requis`;
                        errorElement.classList.add('show');
                    }
                    return false;
                } else {
                    element.classList.remove('error');
                    if (errorElement) {
                        errorElement.classList.remove('show');
                    }
                    return true;
                }
            }

            // Fonction pour rejoindre l'appel Jitsi
            function joinJitsiCall(linkPath) {
                const newWindow = window.open(linkPath, '_blank');
                
                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    // Si la fen√™tre a √©t√© bloqu√©e
                    alert("L'ouverture de la fen√™tre a √©t√© bloqu√©e. Veuillez autoriser les popups pour ce site.");
                    // Option alternative: redirection dans le m√™me onglet
                    if (confirm("Voulez-vous √™tre redirig√© vers l'appel dans cet onglet ?")) {
                        window.location.href = fullLink;
                    }
                }
            }
                
            // Fonction pour cr√©er un message d'erreur
            function creerMessageErreur(element, message) {
                let errorElement = element.parentNode.querySelector('.error-message');
                if (!errorElement) {
                    errorElement = document.createElement('div');
                    errorElement.className = 'error-message';
                    element.parentNode.appendChild(errorElement);
                }
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }

            // Syst√®me de notifications
            function afficherNotification(message, type = 'info', duree = 3000) {
                // Supprimer les notifications existantes
                const notificationsExistantes = document.querySelectorAll('.notification-toast');
                notificationsExistantes.forEach(notif => notif.remove());
                
                // Cr√©er la nouvelle notification
                const notification = document.createElement('div');
                notification.className = `notification-toast notification-${type}`;
                
                const icones = {
                    'success': '<i class="fas fa-check-circle"></i>',
                    'error': '<i class="fas fa-exclamation-circle"></i>',
                    'warning': '<i class="fas fa-exclamation-triangle"></i>',
                    'info': '<i class="fas fa-info-circle"></i>'
                };
                
                notification.innerHTML = `
                    <div class="notification-content">
                        ${icones[type] || icones.info}
                        <span>${message}</span>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Styles CSS inline pour la notification
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    max-width: 400px;
                    animation: slideInRight 0.3s ease-out;
                `;
                
                // Ajouter au DOM
                document.body.appendChild(notification);
                
                // Supprimer automatiquement apr√®s la dur√©e sp√©cifi√©e
                if (duree > 0) {
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.style.animation = 'slideOutRight 0.3s ease-in';
                            setTimeout(() => notification.remove(), 300);
                        }
                    }, duree);
                }
            }

            // Fonctions utilitaires pour les actions PDF
            function ouvrirPDF(url) {
                if (!url || url === 'undefined') {
                    afficherNotification('Erreur: URL du PDF non disponible', 'error');
                    return;
                }
                
                const nouvelleFenetre = window.open(url, '_blank');
                
                if (!nouvelleFenetre) {
                    afficherNotification('Impossible d\'ouvrir le PDF. V√©rifiez que les popups ne sont pas bloqu√©s.', 'warning');
                    window.location.href = url;
                }
            }

            function telechargerPDF(url, nomFichier) {
                if (!url || url === 'undefined') {
                    afficherNotification('Erreur: URL du PDF non disponible', 'error');
                    return;
                }
                
                try {
                    const lienTelechargement = document.createElement('a');
                    lienTelechargement.href = url;
                    lienTelechargement.download = nomFichier || 'document.pdf';
                    lienTelechargement.style.display = 'none';
                    
                    document.body.appendChild(lienTelechargement);
                    lienTelechargement.click();
                    document.body.removeChild(lienTelechargement);
                    
                    afficherNotification('T√©l√©chargement d√©marr√©', 'success');
                    
                } catch (error) {
                    console.error('Erreur t√©l√©chargement:', error);
                    afficherNotification('Erreur lors du t√©l√©chargement. Essayez d\'ouvrir le PDF puis de le sauvegarder.', 'error');
                    ouvrirPDF(url);
                }
            }

            function copierLienPDF(url) {
                if (!url || url === 'undefined') {
                    afficherNotification('Erreur: URL du PDF non disponible', 'error');
                    return;
                }
                
                const urlComplete = url.startsWith('http') ? url : `${window.location.origin}${url}`;
                
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(urlComplete).then(() => {
                            afficherNotification('Lien copi√© dans le presse-papiers', 'success');
                        }).catch(err => {
                            console.error('Erreur copie clipboard:', err);
                            copierLienFallback(urlComplete);
                        });
                    } else {
                        copierLienFallback(urlComplete);
                    }
                } catch (error) {
                    console.error('Erreur copie lien:', error);
                    copierLienFallback(urlComplete);
                }
            }

            function copierLienFallback(url) {
                try {
                    const champTemporaire = document.createElement('textarea');
                    champTemporaire.value = url;
                    champTemporaire.style.position = 'fixed';
                    champTemporaire.style.left = '-999999px';
                    champTemporaire.style.top = '-999999px';
                    document.body.appendChild(champTemporaire);
                    champTemporaire.focus();
                    champTemporaire.select();
                    
                    const reussi = document.execCommand('copy');
                    document.body.removeChild(champTemporaire);
                    
                    if (reussi) {
                        afficherNotification('Lien copi√© dans le presse-papiers', 'success');
                    } else {
                        prompt('Copiez ce lien:', url);
                    }
                } catch (error) {
                    console.error('Erreur copie fallback:', error);
                    prompt('Copiez ce lien:', url);
                }
            }

            // G√©n√©ration des boutons d'action pour les prescriptions
            function genererBoutonsActionsPrescription(data) {
                const numero = data.numero || data.prescription_id || 'unknown';
                const pdfUrl = data.pdf_url || data.url_finale || `/media/prescriptions/ordonnances/${numero}.pdf`;
                
                return `
                    <button class="prescription-btn" onclick="ouvrirPDF('${pdfUrl}')">
                        <i class="fas fa-file-pdf"></i> Voir le PDF
                    </button>
                    <button class="prescription-btn" onclick="telechargerPDF('${pdfUrl}', 'Ordonnance_${numero}.pdf')">
                        <i class="fas fa-download"></i> T√©l√©charger
                    </button>
                    <button class="prescription-btn" onclick="copierLienPDF('${pdfUrl}')">
                        <i class="fas fa-link"></i> Copier le lien
                    </button>
                `;
            }

            // G√©n√©ration des boutons d'action pour les bons d'examens
            function genererBoutonsActionsBonExamen(data) {
                const numero = data.numero || data.bon_examen_id || 'unknown';
                const pdfUrl = data.pdf_url || data.url_finale || `/media/prescriptions/bons_examens/${numero}.pdf`;
                
                return `
                    <button class="prescription-btn" onclick="ouvrirPDF('${pdfUrl}')">
                        <i class="fas fa-file-pdf"></i> Voir le PDF
                    </button>
                    <button class="prescription-btn" onclick="telechargerPDF('${pdfUrl}', 'Bon_Examens_${numero}.pdf')">
                        <i class="fas fa-download"></i> T√©l√©charger
                    </button>
                    <button class="prescription-btn" onclick="copierLienPDF('${pdfUrl}')">
                        <i class="fas fa-link"></i> Copier le lien
                    </button>
                `;
            }

            // Fonction pour ajouter des messages de prescription
            function ajouterMessagePrescription(data) {
                const container = document.getElementById('messagesContainer');
                
                const messageGroup = document.createElement('div');
                messageGroup.className = 'message-group';
                
                const timeString = new Date().toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let contenu = '';
                let icone = '';
                
                // Gestion des diff√©rents types de prescription
                if (data.type === 'prescription_medicament' || data.type === 'prescription_sent') {
                    icone = '<i class="fas fa-pills"></i>';
                    contenu = `
                        <div class="prescription-message">
                            <div class="prescription-header">
                                ${icone} Ordonnance m√©dicale envoy√©e
                            </div>
                            <div class="prescription-details">
                                <strong>N¬∞ ${data.numero || 'N/A'}</strong><br>
                                M√©dicaments prescrits: ${data.medicaments_count || 0}<br>
                                M√©decin: ${data.medecin || 'Dr Non sp√©cifi√©'}
                            </div>
                            <div class="prescription-actions-msg">
                                ${genererBoutonsActionsPrescription(data)}
                            </div>
                        </div>
                    `;
                } else if (data.type === 'bon_examen' || data.type === 'bon_examen_sent') {
                    const prioriteEmoji = (data.priorite && data.priorite.includes('Urgent')) ? '‚ö†Ô∏è' : 'üìã';
                    icone = '<i class="fas fa-microscope"></i>';
                    contenu = `
                        <div class="prescription-message">
                            <div class="prescription-header">
                                ${icone} ${prioriteEmoji} Bon d'examens envoy√©
                            </div>
                            <div class="prescription-details">
                                <strong>N¬∞ ${data.numero || 'N/A'}</strong><br>
                                Examens prescrits: ${data.examens_count || 0}<br>
                                Priorit√©: ${data.priorite || 'Normal'}<br>
                                M√©decin: ${data.medecin || 'Dr Non sp√©cifi√©'}
                            </div>
                            <div class="prescription-actions-msg">
                                ${genererBoutonsActionsBonExamen(data)}
                            </div>
                        </div>
                    `;
                }
                
                messageGroup.innerHTML = `
                    <div class="message-bubble medecin">
                        <div class="message-content medecin">
                            ${contenu}
                        </div>
                        <div class="message-time">
                            ${timeString}
                        </div>
                    </div>
                `;
                
                container.appendChild(messageGroup);
                scrollToBottom();
            }
            
            // Charger les donn√©es de r√©f√©rence
            async function chargerDonneesReference() {
                try {
                    // Charger les produits pharmaceutiques
                    const produitsResponse = await fetch('/api/produits-pharmaceutiques/');
                    if (produitsResponse.ok) {
                        produitsPharmaceutiques = await produitsResponse.json();
                        console.log('‚úÖ Produits pharmaceutiques charg√©s:', produitsPharmaceutiques.length);
                    } else {
                        console.warn('‚ö†Ô∏è Erreur chargement produits pharmaceutiques');
                    }
                    
                    // Charger les actes m√©dicaux
                    const actesResponse = await fetch('/api/actes-medicaux/');
                    if (actesResponse.ok) {
                        actesMedicaux = await actesResponse.json();
                        console.log('‚úÖ Actes m√©dicaux charg√©s:', actesMedicaux.length);
                    } else {
                        console.warn('‚ö†Ô∏è Erreur chargement actes m√©dicaux');
                    }
                } catch (error) {
                    console.error('‚ùå Erreur chargement donn√©es de r√©f√©rence:', error);
                    // Utiliser des donn√©es de test si l'API n'est pas disponible
                    produitsPharmaceutiques = [
                        {id: '1', nom_commercial: 'Parac√©tamol', dosage: '500mg', forme: 'Comprim√©', posologie_adulte: '1 √† 2 comprim√©s, 3 fois par jour', duree_traitement_standard: '3 jours'},
                        {id: '2', nom_commercial: 'Amoxicilline', dosage: '1g', forme: 'Comprim√©', posologie_adulte: '1 comprim√© matin et soir', duree_traitement_standard: '7 jours'}
                    ];
                    actesMedicaux = [
                        {id: '1', nom: 'Num√©ration Formule Sanguine', code: 'B020', categorie: 'BIOLOGIE', preparation_requise: 'Aucune pr√©paration'},
                        {id: '2', nom: 'Radiographie thoracique', code: 'ZBQK001', categorie: 'IMAGERIE', preparation_requise: 'Retirer bijoux m√©talliques'}
                    ];
                    console.log('üìã Utilisation des donn√©es de test');
                }
            }

            // Fonctions pour les modales
            function ouvrirModalPrescription() {
                document.getElementById('prescriptionModal').style.display = 'flex';
                // R√©initialiser le formulaire
                document.getElementById('prescriptionForm').reset();
                document.getElementById('medicaments-container').innerHTML = '';
                medicamentCounter = 0;
                // Ajouter un m√©dicament par d√©faut
                ajouterMedicament();
            }

            function fermerModalPrescription() {
                document.getElementById('prescriptionModal').style.display = 'none';
            }

            function ouvrirModalBonExamen() {
                document.getElementById('bonExamenModal').style.display = 'flex';
                // R√©initialiser le formulaire
                document.getElementById('bonExamenForm').reset();
                document.getElementById('examens-container').innerHTML = '';
                examenCounter = 0;
                // Ajouter un examen par d√©faut
                ajouterExamen();
            }

            function fermerModalBonExamen() {
                document.getElementById('bonExamenModal').style.display = 'none';
            }

            // Fonction pour ajouter un m√©dicament
            function ajouterMedicament() {
                medicamentCounter++;
                const container = document.getElementById('medicaments-container');
                
                const medicamentDiv = document.createElement('div');
                medicamentDiv.className = 'medicament-item';
                medicamentDiv.id = `medicament-${medicamentCounter}`;
                
                let optionsProduits = '<option value="">S√©lectionnez un m√©dicament</option>';
                produitsPharmaceutiques.forEach(produit => {
                    optionsProduits += `<option value="${produit.id}" data-posologie="${produit.posologie_adulte || ''}" data-duree="${produit.duree_traitement_standard || ''}">${produit.nom_commercial} ${produit.dosage} (${produit.forme})</option>`;
                });
                
                medicamentDiv.innerHTML = `
                    <h5>
                        M√©dicament ${medicamentCounter}
                        <button type="button" class="remove-btn" onclick="supprimerMedicament(${medicamentCounter})">
                            <i class="fas fa-times"></i>
                        </button>
                    </h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Produit <span class="required">*</span></label>
                            <select name="produit_${medicamentCounter}" onchange="remplirPosologieDefaut(this, ${medicamentCounter})" required>
                                ${optionsProduits}
                            </select>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Quantit√©</label>
                            <input type="text" name="quantite_${medicamentCounter}" placeholder="Ex: 1 bo√Æte, 30 comprim√©s">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Posologie <span class="required">*</span></label>
                            <textarea name="posologie_${medicamentCounter}" rows="2" placeholder="Ex: 1 comprim√© matin et soir" required></textarea>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Dur√©e du traitement <span class="required">*</span></label>
                            <input type="text" name="duree_traitement_${medicamentCounter}" placeholder="Ex: 7 jours" required>
                            <div class="error-message"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Modalit√©s de prise</label>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" name="avant_repas_${medicamentCounter}"> Avant repas
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" name="avec_repas_${medicamentCounter}"> Avec repas
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" name="apres_repas_${medicamentCounter}"> Apr√®s repas
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Instructions sp√©cifiques</label>
                        <textarea name="instructions_${medicamentCounter}" rows="2" placeholder="Instructions sp√©cifiques pour ce m√©dicament..."></textarea>
                    </div>
                `;
                
                container.appendChild(medicamentDiv);
            }

            // Fonction pour supprimer un m√©dicament
            function supprimerMedicament(id) {
                const element = document.getElementById(`medicament-${id}`);
                if (element) {
                    element.remove();
                }
            }

            // Fonction pour remplir la posologie par d√©faut
            function remplirPosologieDefaut(selectElement, medicamentId) {
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                const posologieDefaut = selectedOption.getAttribute('data-posologie');
                const dureeDefaut = selectedOption.getAttribute('data-duree');
                
                if (posologieDefaut) {
                    const posologieField = document.querySelector(`textarea[name="posologie_${medicamentId}"]`);
                    if (posologieField && !posologieField.value) {
                        posologieField.value = posologieDefaut;
                    }
                }
                
                if (dureeDefaut) {
                    const dureeField = document.querySelector(`input[name="duree_traitement_${medicamentId}"]`);
                    if (dureeField && !dureeField.value) {
                        dureeField.value = dureeDefaut;
                    }
                }
            }

            // Fonction pour ajouter un examen
            function ajouterExamen() {
                examenCounter++;
                const container = document.getElementById('examens-container');
                
                const examenDiv = document.createElement('div');
                examenDiv.className = 'examen-item';
                examenDiv.id = `examen-${examenCounter}`;
                
                let optionsActes = '<option value="">S√©lectionnez un examen</option>';
                
                // Grouper par cat√©gorie
                const categories = {};
                actesMedicaux.forEach(acte => {
                    if (!categories[acte.categorie]) {
                        categories[acte.categorie] = [];
                    }
                    categories[acte.categorie].push(acte);
                });
                
                Object.keys(categories).forEach(categorie => {
                    optionsActes += `<optgroup label="${categorie}">`;
                    categories[categorie].forEach(acte => {
                        optionsActes += `<option value="${acte.id}" data-preparation="${acte.preparation_requise || ''}">${acte.nom} (${acte.code})</option>`;
                    });
                    optionsActes += '</optgroup>';
                });
                
                examenDiv.innerHTML = `
                    <h5>
                        Examen ${examenCounter}
                        <button type="button" class="remove-btn" onclick="supprimerExamen(${examenCounter})">
                            <i class="fas fa-times"></i>
                        </button>
                    </h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Acte m√©dical <span class="required">*</span></label>
                            <select name="acte_${examenCounter}" onchange="remplirPreparationDefaut(this, ${examenCounter})" required>
                                ${optionsActes}
                            </select>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Localisation</label>
                            <input type="text" name="localisation_${examenCounter}" placeholder="Ex: genou droit, thorax">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Instructions sp√©cifiques</label>
                            <textarea name="instructions_specifiques_${examenCounter}" rows="2" placeholder="Instructions sp√©cifiques pour cet examen..."></textarea>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" name="urgent_${examenCounter}"> Examen urgent
                            </label>
                        </div>
                    </div>
                `;
                
                container.appendChild(examenDiv);
            }

            // Fonction pour supprimer un examen
            function supprimerExamen(id) {
                const element = document.getElementById(`examen-${id}`);
                if (element) {
                    element.remove();
                }
            }

            // Fonction pour remplir la pr√©paration par d√©faut
            function remplirPreparationDefaut(selectElement, examenId) {
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                const preparationDefaut = selectedOption.getAttribute('data-preparation');
                
                if (preparationDefaut) {
                    const instructionsField = document.querySelector(`textarea[name="instructions_specifiques_${examenId}"]`);
                    if (instructionsField && !instructionsField.value) {
                        instructionsField.value = `Pr√©paration: ${preparationDefaut}`;
                    }
                }
            }

            // CORRECTION: Fonction pour envoyer la prescription avec validation des IDs
            async function envoyerPrescription() {
                try {
                    // CORRECTION: V√©rification des IDs avant envoi
                    if (sessionId === 0 || medecinId === 0) {
                        afficherNotification('Erreur: Donn√©es de session manquantes. Veuillez recharger la page.', 'error');
                        console.error('‚ùå IDs manquants - Session ID:', sessionId, 'Medecin ID:', medecinId);
                        return;
                    }
                    
                    // Validation des champs requis
                    const diagnostic = document.getElementById('diagnostic');
                    let isValid = true;
                    
                    if (!validerChampRequis(diagnostic, 'Diagnostic')) {
                        isValid = false;
                    }
                    
                    // Valider les m√©dicaments
                    const medicamentsContainer = document.getElementById('medicaments-container');
                    const medicamentItems = medicamentsContainer.querySelectorAll('.medicament-item');
                    
                    if (medicamentItems.length === 0) {
                        afficherNotification('Veuillez ajouter au moins un m√©dicament', 'error');
                        return;
                    }
                    
                    const medicaments = [];
                    medicamentItems.forEach((item, index) => {
                        const id = item.id.split('-')[1];
                        const produitSelect = item.querySelector(`select[name="produit_${id}"]`);
                        const posologieTextarea = item.querySelector(`textarea[name="posologie_${id}"]`);
                        const dureeInput = item.querySelector(`input[name="duree_traitement_${id}"]`);
                        
                        if (!validerChampRequis(produitSelect, 'Produit')) {
                            isValid = false;
                        }
                        if (!validerChampRequis(posologieTextarea, 'Posologie')) {
                            isValid = false;
                        }
                        if (!validerChampRequis(dureeInput, 'Dur√©e du traitement')) {
                            isValid = false;
                        }
                        
                        if (produitSelect.value && posologieTextarea.value && dureeInput.value) {
                            medicaments.push({
                                produit_id: parseInt(produitSelect.value),
                                quantite: item.querySelector(`input[name="quantite_${id}"]`).value || '',
                                posologie: posologieTextarea.value,
                                duree_traitement: dureeInput.value,
                                instructions: item.querySelector(`textarea[name="instructions_${id}"]`).value || '',
                                avant_repas: item.querySelector(`input[name="avant_repas_${id}"]`).checked,
                                avec_repas: item.querySelector(`input[name="avec_repas_${id}"]`).checked,
                                apres_repas: item.querySelector(`input[name="apres_repas_${id}"]`).checked,
                                substitution_autorisee: true
                            });
                        }
                    });
                    
                    if (!isValid) {
                        afficherNotification('Veuillez corriger les erreurs dans le formulaire', 'error');
                        return;
                    }
                    
                    if (medicaments.length === 0) {
                        afficherNotification('Veuillez remplir au moins un m√©dicament correctement', 'error');
                        return;
                    }
                    
                    // Pr√©parer les donn√©es
                    const prescriptionData = {
                        diagnostic: diagnostic.value,
                        motif: document.getElementById('motif_prescription').value || '',
                        instructions_generales: document.getElementById('instructions_generales').value || '',
                        date_validite: document.getElementById('date_validite').value || '',
                        renouvellement_autorise: document.getElementById('renouvelable').checked,
                        medicaments: medicaments
                    };
                    
                    // CORRECTION: Structure des donn√©es conforme aux attentes de la vue Django
                    const requestData = {
                        session_id: sessionId,
                        medecin_id: medecinId,
                        prescription_data: prescriptionData
                    };
                    
                    console.log('üì§ Envoi des donn√©es:', requestData);
                    
                    // Envoyer la requ√™te
                    const response = await fetch('/api/creer-prescription/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    console.log('üì• R√©ponse re√ßue:', result);
                    
                    if (result.status === 'success') {
                        afficherNotification('Ordonnance cr√©√©e et envoy√©e avec succ√®s!', 'success');
                        fermerModalPrescription();
                        
                        // Ajouter le message dans le chat
                        ajouterMessagePrescription({
                            type: 'prescription_medicament',
                            numero: result.numero,
                            medicaments_count: medicaments.length,
                            medecin: result.medecin,
                            pdf_url: result.pdf_url
                        });
                    } else {
                        afficherNotification(`Erreur: ${result.message}`, 'error');
                        console.error('‚ùå Erreur serveur:', result);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erreur envoi prescription:', error);
                    afficherNotification('Erreur lors de l\'envoi de la prescription', 'error');
                }
            }

            // CORRECTION: Fonction pour envoyer le bon d'examens avec validation des IDs
            async function envoyerBonExamen() {
                try {
                    // CORRECTION: V√©rification des IDs avant envoi
                    if (sessionId === 0 || medecinId === 0) {
                        afficherNotification('Erreur: Donn√©es de session manquantes. Veuillez recharger la page.', 'error');
                        console.error('‚ùå IDs manquants - Session ID:', sessionId, 'Medecin ID:', medecinId);
                        return;
                    }
                    
                    // Validation des champs requis
                    const motifExamens = document.getElementById('motif_examens');
                    let isValid = true;
                    
                    if (!validerChampRequis(motifExamens, 'Motif des examens')) {
                        isValid = false;
                    }
                    
                    // Valider les examens
                    const examensContainer = document.getElementById('examens-container');
                    const examenItems = examensContainer.querySelectorAll('.examen-item');
                    
                    if (examenItems.length === 0) {
                        afficherNotification('Veuillez ajouter au moins un examen', 'error');
                        return;
                    }
                    
                    const examens = [];
                    examenItems.forEach((item, index) => {
                        const id = item.id.split('-')[1];
                        const acteSelect = item.querySelector(`select[name="acte_${id}"]`);
                        
                        if (!validerChampRequis(acteSelect, 'Acte m√©dical')) {
                            isValid = false;
                        }
                        
                        if (acteSelect.value) {
                            examens.push({
                                acte_id: parseInt(acteSelect.value),
                                localisation: item.querySelector(`input[name="localisation_${id}"]`).value || '',
                                instructions_specifiques: item.querySelector(`textarea[name="instructions_specifiques_${id}"]`).value || '',
                                urgent: item.querySelector(`input[name="urgent_${id}"]`).checked
                            });
                        }
                    });
                    
                    if (!isValid) {
                        afficherNotification('Veuillez corriger les erreurs dans le formulaire', 'error');
                        return;
                    }
                    
                    if (examens.length === 0) {
                        afficherNotification('Veuillez s√©lectionner au moins un examen', 'error');
                        return;
                    }
                    
                    // Calculer la date de validit√©
                    const validiteJours = parseInt(document.getElementById('validite_jours').value) || 60;
                    const dateValidite = new Date();
                    dateValidite.setDate(dateValidite.getDate() + validiteJours);
                    
                    // Pr√©parer les donn√©es
                    const bonExamenData = {
                        motif: motifExamens.value,
                        diagnostic_provisoire: document.getElementById('diagnostic_provisoire').value || '',
                        renseignements_cliniques: document.getElementById('renseignements_cliniques').value || '',
                        instructions_preparation: document.getElementById('instructions_preparation').value || '',
                        priorite: document.getElementById('priorite').value,
                        delai_realisation: document.getElementById('delai_realisation').value || '',
                        date_validite: dateValidite.toISOString().split('T')[0],
                        examens: examens
                    };
                    
                    // CORRECTION: Structure des donn√©es conforme aux attentes de la vue Django
                    const requestData = {
                        session_id: sessionId,
                        medecin_id: medecinId,
                        bon_examen_data: bonExamenData
                    };
                    
                    console.log('üì§ Envoi des donn√©es bon d\'examens:', requestData);
                    
                    // Envoyer la requ√™te
                    const response = await fetch('/api/creer-bon-examen/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    console.log('üì• R√©ponse bon d\'examens re√ßue:', result);
                    
                    if (result.status === 'success') {
                        afficherNotification('Bon d\'examens cr√©√© et envoy√© avec succ√®s!', 'success');
                        fermerModalBonExamen();
                        
                        // Ajouter le message dans le chat
                        ajouterMessagePrescription({
                            type: 'bon_examen',
                            numero: result.numero,
                            examens_count: examens.length,
                            priorite: bonExamenData.priorite,
                            medecin: result.medecin,
                            pdf_url: result.pdf_url
                        });
                    } else {
                        afficherNotification(`Erreur: ${result.message}`, 'error');
                        console.error('‚ùå Erreur serveur bon d\'examens:', result);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erreur envoi bon d\'examens:', error);
                    afficherNotification('Erreur lors de l\'envoi du bon d\'examens', 'error');
                }
            }
            
            // Initialisation WebSocket
            function initializeWebSocket() {
                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws/discussion/${sessionId}/`;
                    
                    discussionSocket = new WebSocket(wsUrl);
                    
                    discussionSocket.onopen = function(e) {
                        console.log('‚úÖ WebSocket connect√© avec succ√®s');
                    };
                    
                    discussionSocket.onmessage = function(e) {
                        try {
                            const data = JSON.parse(e.data);
                            console.log('üì® Message WebSocket re√ßu:', data);
                            
                            if (data.type === 'prescription_sent' || data.type === 'bon_examen_sent') {
                                ajouterMessagePrescription(data.data);
                            } else if (data.type === 'new_message') {
                                addNewMessage(data.data);
                            } else if (data.type === 'new_media') {
                                addNewMedia(data.data);
                            } else if (data.type === 'message') {
                                // Recharger la page pour afficher le nouveau message
                                location.reload();
                            }
                        } catch (error) {
                            console.error('Erreur parsing message WebSocket:', error);
                        }
                    };
                    
                    discussionSocket.onclose = function(e) {
                        console.log('üîå WebSocket ferm√©. Tentative de reconnexion dans 3 secondes...');
                        setTimeout(initializeWebSocket, 3000);
                    };
                    
                    discussionSocket.onerror = function(e) {
                        console.error('‚ùå Erreur WebSocket:', e);
                    };
                    
                } catch (error) {
                    console.error('‚ùå Erreur initialisation WebSocket:', error);
                }
            }

            
            
            // Initialisation
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üöÄ Initialisation de la page discussion');
                console.log('üìä Variables globales - Session ID:', sessionId, 'Medecin ID:', medecinId);
                
                scrollToBottom();
                chargerDonneesReference();
                
                // Focus sur le champ de message
                const messageInput = document.querySelector('.message-input');
                if (messageInput) {
                    messageInput.focus();
                    
                    // Auto-resize du textarea
                    messageInput.addEventListener('input', function() {
                        autoResize(this);
                    });
                    
                    // Envoi avec Ctrl+Enter
                    messageInput.addEventListener('keydown', function(e) {
                        if (e.ctrlKey && e.key === 'Enter') {
                            e.preventDefault();
                            document.getElementById('messageForm').dispatchEvent(new Event('submit'));
                        }
                    });
                }
                
                // Initialiser WebSocket seulement si sessionId est valide
                if (sessionId > 0) {
                    initializeWebSocket();
                } else {
                    console.warn('‚ö†Ô∏è WebSocket non initialis√© - Session ID invalide');
                }
                
                // Fermer les modales en cliquant √† l'ext√©rieur
                window.addEventListener('click', function(e) {
                    const prescriptionModal = document.getElementById('prescriptionModal');
                    const bonExamenModal = document.getElementById('bonExamenModal');
                    
                    if (e.target === prescriptionModal) {
                        fermerModalPrescription();
                    }
                    if (e.target === bonExamenModal) {
                        fermerModalBonExamen();
                    }
                });
            });

            function addNewMessage(data) {
                const messagesContainer = document.getElementById('messagesContainer');
                
                // D√©terminer la classe en fonction de l'√©metteur
                const senderClass = data.sender === 'medecin' ? 'medecin' : 'patient';
                
                // Cr√©er le HTML du message
                const messageGroup = document.createElement('div');
                messageGroup.className = 'message-group';
                
                // Gestion sp√©ciale pour les liens Jitsi
                let messageContent = '';
                if (data.content.includes("Lien pour la consultation vid√©o:")) {
                    messageContent = `
                        <div class="jitsi-message">
                            <p>${data.content.replace(/\n/g, '<br>')}</p>
                            <div class="media-actions">
                                <button onclick="joinJitsiCall('${data.content.slice(34)}')" 
                                        class="lobiko-btn lobiko-btn-sm lobiko-btn-success">
                                    <i class="fas fa-video"></i> Rejoindre l'appel vid√©o
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    messageContent = `<p class="text-message">${data.content.replace(/\n/g, '<br>')}</p>`;
                }
                
                messageGroup.innerHTML = `
                    <div class="message-bubble ${senderClass}">
                        <div class="message-content ${senderClass}">
                            ${messageContent}
                        </div>
                        <div class="message-time">
                            ${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageGroup);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function addNewMedia(data) {
                const messagesContainer = document.getElementById('messagesContainer');
                
                // D√©terminer la classe en fonction de l'√©metteur
                const senderClass = data.sender === 'medecin' ? 'medecin' : 'patient';
                
                // D√©terminer le contenu HTML en fonction du type de m√©dia
                let mediaContent = '';
                if (data.type === 'image') {
                    mediaContent = `
                        <div class="media-container">
                            <img src="${data.url}" alt="Image envoy√©e" loading="lazy">
                            <div class="media-actions">
                                <a href="${data.url}" target="_blank" class="lobiko-btn lobiko-btn-sm lobiko-btn-outline">
                                    <i class="fas fa-expand"></i> Agrandir
                                </a>
                                <a href="/medecins/media/download/${sessionId}/${data.id}/" class="lobiko-btn lobiko-btn-sm lobiko-btn-primary">
                                    <i class="fas fa-download"></i> T√©l√©charger
                                </a>
                            </div>
                        </div>
                    `;
                } else if (data.type === 'audio') {
                    mediaContent = `
                        <div class="audio-container">
                            <audio controls>
                                <source src="${data.url}" type="${data.mime_type}">
                                Votre navigateur ne supporte pas l'audio.
                            </audio>
                            <div class="media-actions">
                                <a href="/medecins/media/download/${sessionId}/${data.id}/" class="lobiko-btn lobiko-btn-sm lobiko-btn-primary">
                                    <i class="fas fa-download"></i> T√©l√©charger
                                </a>
                            </div>
                        </div>
                    `;
                } else if (data.type === 'video') {
                    mediaContent = `
                        <div class="video-container">
                            <video controls width="300">
                                <source src="${data.url}" type="${data.mime_type}">
                                Votre navigateur ne supporte pas la vid√©o.
                            </video>
                            <div class="media-actions">
                                <a href="/medecins/media/download/${sessionId}/${data.id}/" class="lobiko-btn lobiko-btn-sm lobiko-btn-primary">
                                    <i class="fas fa-download"></i> T√©l√©charger
                                </a>
                            </div>
                        </div>
                    `;
                } else {
                    mediaContent = `
                        <div class="document-container">
                            <div class="document-info">
                                <i class="fas fa-file-alt"></i>
                                <span>${data.name || 'Document'}</span>
                            </div>
                            <div class="media-actions">
                                <a href="${data.url}" target="_blank" class="lobiko-btn lobiko-btn-sm lobiko-btn-outline">
                                    <i class="fas fa-eye"></i> Voir
                                </a>
                                <a href="/medecins/media/download/${sessionId}/${data.id}/" class="lobiko-btn lobiko-btn-sm lobiko-btn-primary">
                                    <i class="fas fa-download"></i> T√©l√©charger
                                </a>
                            </div>
                        </div>
                    `;
                }
                
                // Cr√©er le HTML du message m√©dia
                const messageGroup = document.createElement('div');
                messageGroup.className = 'message-group';
                
                messageGroup.innerHTML = `
                    <div class="message-bubble ${senderClass}">
                        <div class="message-content ${senderClass}">
                            <div class="media-message">
                                ${mediaContent}
                                ${data.caption ? `<p class="media-caption">${data.caption}</p>` : ''}
                            </div>
                        </div>
                        <div class="message-time">
                            ${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageGroup);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

        </script>
    </body>
    </html>

