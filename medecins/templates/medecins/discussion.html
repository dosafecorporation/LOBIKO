{% load static %}
{% load crispy_forms_tags %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Discussion - Lobiko</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'medecins/style.css' %}" />
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="#">Lobiko - Médecin</a>
    <div>
      <a href="{% url 'logout_medecin' %}" class="btn btn-outline-danger">Déconnexion</a>
    </div>
  </div>
</nav>

<div class="container mt-4">
    <h2>Discussion avec {{ session.patient.nom }} {{ session.patient.postnom }}</h2>
    <p><strong>Début de session :</strong> {{ session.date_debut|date:"d/m/Y H:i" }}</p>
    {% if session.date_fin %}
        <p class="text-danger"><strong>Session terminée :</strong> {{ session.date_fin|date:"d/m/Y H:i" }}</p>
    {% endif %}

    <div class="border p-3 mb-4" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
        {% for msg in messages %}
            {% if msg.emetteur == 'medecin' %}
                <div class="text-end mb-2">
                    <span class="badge bg-primary">Vous</span><br>
                    <div class="alert alert-primary d-inline-block">
                        {{ msg.contenu|linebreaksbr }}
                        <br><small class="text-muted">{{ msg.timestamp|date:"H:i d/m/Y" }}</small>
                    </div>
                </div>
            {% elif msg.emetteur == 'patient' %}
                <div class="text-start mb-2">
                    <span class="badge bg-success">{{ session.patient.prenom }}</span><br>
                    <div class="alert alert-success d-inline-block">
                        {{ msg.contenu|linebreaksbr }}
                        <br><small class="text-muted">{{ msg.timestamp|date:"H:i d/m/Y" }}</small>
                    </div>
                </div>
            {% else %}
                <div class="text-center mb-2">
                    <span class="badge bg-secondary">Bot</span><br>
                    <div class="alert alert-secondary d-inline-block">
                        {{ msg.contenu|linebreaksbr }}
                        <br><small class="text-muted">{{ msg.timestamp|date:"H:i d/m/Y" }}</small>
                    </div>
                </div>
            {% endif %}
        {% empty %}
            <p class="text-center text-muted">Aucun message pour le moment.</p>
        {% endfor %}
    </div>

    {% if not session.date_fin %}
    <form method="POST" class="mb-3">
        {% csrf_token %}
        {{ form.message.label_tag }}
        {{ form.message }}
        <button type="submit" class="btn btn-primary mt-2">Envoyer</button>
        <button type="submit" name="close_session" class="btn btn-danger float-end mt-2">Terminer la session</button>
    </form>
    {% else %}
        <div class="alert alert-warning">La session est terminée. Vous ne pouvez plus envoyer de messages.</div>
    {% endif %}
</div>
</body>
</html>